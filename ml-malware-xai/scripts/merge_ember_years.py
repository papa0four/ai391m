# scripts/merge_ember_years.py
from __future__ import annotations
import os, argparse, numpy as np

def load_npz(path):
    d = np.load(path, allow_pickle=True)
    X = d["X"]
    y = d["y"]
    feat_names = list(d["feat_names"])
    return X, y, feat_names

def save_npz(path, X, y, feat_names, class_names=("benign","malicious")):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    np.savez_compressed(path,
        X=X.astype(np.float32),
        y=y.astype(np.int64),
        feat_names=np.array(feat_names, dtype=object),
        class_names=np.array(class_names, dtype=object)
    )

def main():
    ap = argparse.ArgumentParser(description="Merge EMBER 2017 v2 + 2018 v2 into a single features.npz")
    ap.add_argument("--npz_2017", required=True)
    ap.add_argument("--npz_2018", required=True)
    ap.add_argument("--out_npz", required=True)
    ap.add_argument("--drop_unlabeled", action="store_true", default=True)
    ap.add_argument("--max_benign_ratio", type=float, default=3.0,
                    help="Cap benign:malicious ratio via downsampling (default 3:1)")
    ap.add_argument("--seed", type=int, default=42)
    args = ap.parse_args()

    X17, y17, f17 = load_npz(args.npz_2017)
    X18, y18, f18 = load_npz(args.npz_2018)

    # schema check
    if len(f17) != len(f18) or any(a!=b for a,b in zip(f17, f18)):
        raise ValueError("Feature schemas differ. Ensure both are v2 or align columns first.")

    # drop unlabeled (-1)
    if args.drop_unlabeled:
        m17 = (y17 != -1)
        m18 = (y18 != -1)
        X17, y17 = X17[m17], y17[m17]
        X18, y18 = X18[m18], y18[m18]

    # concatenate
    X = np.vstack([X17, X18])
    y = np.concatenate([y17, y18])
    print(f"[INFO] merged: X={X.shape}, positives={(y==1).sum()}, negatives={(y==0).sum()}")

    # benign ratio capping (prevent 2017 benign flood)
    rng = np.random.default_rng(args.seed)
    pos_idx = np.where(y == 1)[0]
    neg_idx = np.where(y == 0)[0]
    max_neg = int(args.max_benign_ratio * len(pos_idx))
    if len(neg_idx) > max_neg:
        keep_neg = rng.choice(neg_idx, size=max_neg, replace=False)
        keep = np.concatenate([pos_idx, keep_neg])
        keep.sort()
        X, y = X[keep], y[keep]
        print(f"[INFO] downsampled benigns to {args.max_benign_ratio:.1f}:1 ratio â†’ X={X.shape}")

    save_npz(args.out_npz, X, y, f18)
    print(f"[OK] wrote {args.out_npz}")

if __name__ == "__main__":
    main()
