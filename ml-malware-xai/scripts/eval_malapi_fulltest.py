import os, json, joblib, numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import classification_report, f1_score, confusion_matrix

# ==== EDIT THESE 2 PATHS IF YOUR TAGS CHANGE ====
NPZ   = r".\outputs\metrics\datasets\malapi2019_classify_20251111_105233.npz"
MODEL = r".\outputs\models\malapi2019_classify_20251111_105233_catboost_20251111_112558.pkl"
# ===============================================

OUTDIR = r".\outputs\case_study"
TAG = "malapi2019_classify_20251111_105233_fulltest"

def load_test_split(npz_path):
    d = np.load(npz_path, allow_pickle=True)
    keys = set(d.keys())
    for Xk, yk in [("X_te","y_te"), ("X_test","y_test"), ("X","y")]:
        if Xk in keys and yk in keys:
            return d[Xk], d[yk], d
    if "X_test" in keys and "y_test" in keys:
        return d["X_test"], d["y_test"], d
    raise KeyError(f"Cannot find test split in {npz_path}. Keys: {list(keys)}")

os.makedirs(OUTDIR, exist_ok=True)
CSV_OUT = os.path.join(OUTDIR, f"{TAG}_preds.csv")
MET_JSON = os.path.join(OUTDIR, f"{TAG}_metrics.json")
FIG_CM   = os.path.join(OUTDIR, f"{TAG}_confusion.png")

# --- LOAD ---
X, y, d = load_test_split(NPZ)
class_names = d["class_names"].tolist() if "class_names" in d else [str(i) for i in range(X.shape[1])]
clf = joblib.load(MODEL)

# --- SCORE ---
probs = clf.predict_proba(X)          # (n, C)
preds = probs.argmax(axis=1)

# --- METRICS ---
macro_f1   = f1_score(y, preds, average="macro")
weighted_f1= f1_score(y, preds, average="weighted")
rep = classification_report(y, preds, target_names=class_names, output_dict=True)

with open(MET_JSON, "w", encoding="utf-8") as f:
    json.dump({
        "dataset": "Mal-API 2019 (test)",
        "n_test": int(X.shape[0]),
        "macro_f1": float(macro_f1),
        "weighted_f1": float(weighted_f1),
        "per_class": {
            k: {"precision": v["precision"], "recall": v["recall"], "f1": v["f1-score"], "support": int(v["support"])}
            for k,v in rep.items() if k in class_names
        }
    }, f, indent=2)

# --- predictions CSV with top-3
with open(CSV_OUT, "w", encoding="utf-8") as f:
    f.write("index,y_true,y_pred,top1,top1_p,top2,top2_p,top3,top3_p\n")
    for i,(yt,p) in enumerate(zip(y, probs)):
        order = np.argsort(-p)
        def top(j):
            if j < len(order):
                return class_names[order[j]], float(p[order[j]])
            return "", ""
        t1,t2,t3 = top(0), top(1), top(2)
        f.write(f"{i},{int(yt)},{int(order[0])},{t1[0]},{t1[1]},{t2[0]},{t2[1]},{t3[0]},{t3[1]}\n")

# --- CONFUSION ---
cm = confusion_matrix(y, preds, labels=list(range(len(class_names))))
plt.figure(figsize=(7,6))
plt.imshow(cm, cmap="viridis")
for (i,j),v in np.ndenumerate(cm):
    plt.text(j, i, str(v), ha="center", va="center",
             color="white" if v>cm.max()/2 else "black", fontsize=8)
plt.xticks(range(len(class_names)), class_names, rotation=45, ha="right")
plt.yticks(range(len(class_names)), class_names)
plt.xlabel("Predicted label"); plt.ylabel("True label"); plt.title("Mal-API Confusion (full test)")
plt.tight_layout(); plt.savefig(FIG_CM, dpi=150); plt.close()

print("Wrote:\n ", MET_JSON, "\n ", CSV_OUT, "\n ", FIG_CM)
