import numpy as np
import pandas as pd
from pathlib import Path

def main():
    base = Path("data/bodmas")

    # 1. Load full engineered feature matrix (detection NPZ)
    npz_path = base / "bodmas.npz"
    d = np.load(npz_path, allow_pickle=True)
    X_full = d["X"]  # (134435, 2381)
    print("[INFO] Loaded X_full:", X_full.shape)

    # 2. Load metadata (maps hash → row index)
    meta = pd.read_csv(base / "bodmas_metadata.csv")

    # 3. Load malware family labels
    fam = pd.read_csv(base / "bodmas_malware_category.csv")

    print("[INFO] meta rows:", len(meta))
    print("[INFO] fam rows:", len(fam))

    # 4. Merge on sha / sha256
    df = meta.merge(fam, left_on="sha", right_on="sha256", how="inner")
    print("[INFO] merged malware rows:", len(df))

    # 5. The merged df’s index corresponds to X_full’s row index
    idx = df.index.to_numpy()
    X = X_full[idx]

    # 6. Encode malware families (category column)
    families = sorted(df["category"].unique())
    family_to_int = {f: i for i, f in enumerate(families)}
    y = df["category"].map(family_to_int).to_numpy()

    # 7. Create feature names and class names
    n_feats = X.shape[1]
    feat_names = np.array([f"feat_{i}" for i in range(n_feats)])
    class_names = np.array(families, dtype=object)

    # 8. Save final NPZ
    out = base / "bodmas_family.npz"
    np.savez(out, X=X, y=y, feat_names=feat_names, class_names=class_names)

    print(f"[OK] Saved {out}")
    print(f"[INFO] Final shapes: X={X.shape}, y={y.shape}")
    print(f"[INFO] num families={len(class_names)}")

if __name__ == "__main__":
    main()
