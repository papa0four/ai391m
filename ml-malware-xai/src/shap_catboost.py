import argparse
import os

import joblib
import numpy as np
import shap
import matplotlib.pyplot as plt

from catboost import CatBoostClassifier


def load_npz_bundle(path):
    data = np.load(path, allow_pickle=True)
    X_train = data["X_train"]
    X_val = data["X_val"]
    X_test = data["X_test"]
    y_train = data["y_train"]
    y_val = data["y_val"]
    y_test = data["y_test"]
    return X_train, X_val, X_test, y_train, y_val, y_test


def sample_background_and_test(X_train, X_test, background_size=200, test_size=2000, random_state=42):
    rng = np.random.default_rng(random_state)

    # Background
    if X_train.shape[0] > background_size:
        idx_bg = rng.choice(X_train.shape[0], size=background_size, replace=False)
        background = X_train[idx_bg]
    else:
        background = X_train

    # Test subset for plotting
    if X_test.shape[0] > test_size:
        idx_te = rng.choice(X_test.shape[0], size=test_size, replace=False)
        X_test_sub = X_test[idx_te]
    else:
        X_test_sub = X_test

    return background, X_test_sub


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--npz_path", required=True, help="Path to dataset NPZ bundle")
    parser.add_argument("--model_path", required=True, help="Path to trained CatBoost model (.cb or .pkl)")
    parser.add_argument("--fig_prefix", required=True, help="Prefix for output figures, e.g., ember, big2015")
    parser.add_argument("--out_dir", default="outputs/figures", help="Directory to write SHAP figures")
    parser.add_argument("--background_size", type=int, default=200)
    parser.add_argument("--test_size", type=int, default=2000)
    args = parser.parse_args()

    os.makedirs(args.out_dir, exist_ok=True)

    # 1. Load data and model
    X_train, X_val, X_test, y_train, y_val, y_test = load_npz_bundle(args.npz_path)

    # Load model depending on file type
    ext = os.path.splitext(args.model_path)[1].lower()

    if ext in [".cbm", ".cb"]:
        # Native CatBoost format
        model = CatBoostClassifier()
        model.load_model(args.model_path)
    elif ext in [".pkl", ".pickle"]:
        # Joblib or pickle format
        model = joblib.load(args.model_path)
    else:
        raise ValueError(f"Unsupported model file extension: {ext}")

    # 2. Sample background and test subset
    background, X_test_sub = sample_background_and_test(
        X_train, X_test,
        background_size=args.background_size,
        test_size=args.test_size,
    )

    # 3. SHAP TreeExplainer
    explainer = shap.TreeExplainer(model, data=background, model_output="probability")
    shap_values = explainer.shap_values(X_test_sub)

    # 4. Summary plot (global)
    shap.summary_plot(
        shap_values,
        X_test_sub,
        show=False
    )
    
    fig = plt.gcf()
    ax = plt.gca()
    ax.set_title(f"{args.fig_prefix} SHAP summary", fontsize=10)
    
    plt.tight_layout()
    summary_path = os.path.join(args.out_dir, f"{args.fig_prefix}_shap_summary.png")
    plt.savefig(summary_path, dpi=300)
    plt.close()

    # 5. Optional: bar plot for mean |SHAP| per feature
    shap.summary_plot(
        shap_values,
        X_test_sub,
        plot_type="bar",
        show=False
    )
    
    fig = plt.gcf()
    ax = plt.gca()
    ax.set_title(f"{args.fig_prefix} SHAP feature importance", fontsize=10)
    
    plt.tight_layout()
    bar_path = os.path.join(args.out_dir, f"{args.fig_prefix}_shap_importance.png")
    plt.savefig(bar_path, dpi=300)
    plt.close()

    print("Saved SHAP figures:")
    print("  ", summary_path)
    print("  ", bar_path)


if __name__ == "__main__":
    main()
